#!/bin/bash

# Pre-commit hook to prevent secrets from being committed
# Scans staged files for common secret patterns

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "Scanning for secrets..."

# Get list of staged files (excluding deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

SECRETS_FOUND=0

for FILE in $STAGED_FILES; do
    # Skip binary files
    if [[ "$FILE" =~ \.(png|jpg|jpeg|gif|ico|woff|woff2|ttf|eot|pdf)$ ]]; then
        continue
    fi

    # Block .env files entirely
    if [[ "$FILE" =~ ^\.env ]] || [[ "$FILE" == ".env.local" ]] || [[ "$FILE" == ".env" ]]; then
        echo -e "${RED}BLOCKED: .env file staged: $FILE${NC}"
        SECRETS_FOUND=1
        continue
    fi

    # Get the staged content
    CONTENT=$(git show ":$FILE" 2>/dev/null)

    if [ -z "$CONTENT" ]; then
        continue
    fi

    # 1. Long JWTs (Supabase keys, etc.) - look for eyJ followed by 100+ base64 chars
    if echo "$CONTENT" | grep -E 'eyJ[A-Za-z0-9_-]{50,}' | grep -qv '\$' 2>/dev/null; then
        # Check it's not a variable reference
        MATCH=$(echo "$CONTENT" | grep -E 'eyJ[A-Za-z0-9_-]{50,}' | head -1)
        if [[ ! "$MATCH" =~ \$[A-Z_] ]]; then
            echo -e "${RED}BLOCKED: JWT/API key in: $FILE${NC}"
            echo "  Found: eyJ... (long JWT token)"
            SECRETS_FOUND=1
        fi
    fi

    # 2. AWS Access Keys
    if echo "$CONTENT" | grep -qE 'AKIA[0-9A-Z]{16}' 2>/dev/null; then
        echo -e "${RED}BLOCKED: AWS Access Key in: $FILE${NC}"
        SECRETS_FOUND=1
    fi

    # 3. Anthropic API keys
    if echo "$CONTENT" | grep -qE 'sk-ant-[a-zA-Z0-9-]{20,}' 2>/dev/null; then
        echo -e "${RED}BLOCKED: Anthropic API key in: $FILE${NC}"
        SECRETS_FOUND=1
    fi

    # 4. OpenAI API keys (sk- followed by 40+ chars, but not sk-ant)
    if echo "$CONTENT" | grep -E 'sk-[a-zA-Z0-9]{40,}' 2>/dev/null | grep -qv 'sk-ant' 2>/dev/null; then
        echo -e "${RED}BLOCKED: OpenAI API key in: $FILE${NC}"
        SECRETS_FOUND=1
    fi

    # 5. Private key blocks (skip hook files themselves)
    if [[ ! "$FILE" =~ \.githooks/ ]] && echo "$CONTENT" | grep -q 'BEGIN.*PRIVATE KEY' 2>/dev/null; then
        echo -e "${RED}BLOCKED: Private key in: $FILE${NC}"
        SECRETS_FOUND=1
    fi

    # 6. Hardcoded SERVICE_KEY= with a value (not a variable reference)
    if echo "$CONTENT" | grep -E 'SERVICE_KEY="[A-Za-z0-9]' 2>/dev/null | grep -qv 'SERVICE_KEY="\$' 2>/dev/null; then
        echo -e "${RED}BLOCKED: Hardcoded SERVICE_KEY in: $FILE${NC}"
        SECRETS_FOUND=1
    fi

    # 7. Hardcoded service_role with JWT
    if echo "$CONTENT" | grep -qiE 'service.?role.*eyJ' 2>/dev/null; then
        echo -e "${RED}BLOCKED: Service role key in: $FILE${NC}"
        SECRETS_FOUND=1
    fi

done

if [ $SECRETS_FOUND -ne 0 ]; then
    echo ""
    echo -e "${YELLOW}========================================${NC}"
    echo -e "${YELLOW}  COMMIT BLOCKED - SECRETS DETECTED!  ${NC}"
    echo -e "${YELLOW}========================================${NC}"
    echo ""
    echo "Fix: Remove secrets and use environment variables instead"
    echo "Bypass (dangerous): git commit --no-verify"
    echo ""
    exit 1
fi

echo -e "${GREEN}No secrets detected.${NC}"
exit 0
